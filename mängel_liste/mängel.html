<!DOCTYPE html>
<html>
  <head>
  <meta charset="UTF-8">
  <meta  name="viewport" content="width=device-width", initial-scale="1" >
  <title id="title_change"></title>
    <link rel="icon" type="image/x-icon" href="/favicon/favicon.png">
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js" integrity="sha512-YcsIPGdhPK4P/uRW6/sruonlYj+Q7UHWeKfTAkBW+g83NKM+jMJFJ4iAPfSnVp7BKD4dKMHmVSvICUbE/V1sSw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  </head>

  <body id="el-to-print">
    <div class="div1">
      <div>
        <h3>Cold4you Gewerbekälte GmbH</h3>
        <p style="font-size: large">Wiener Strasse 25, 2100 Korneuburg</p>
        <p style="font-size: large">Tel: 02262 / 235 25 </p>
        <p style="font-size: large">Email: office@cold4you.at </p>
        <p style="font-size: large">www.cold4you.at </p>
      </div>
      <div>
        <h1>Mängel Liste - Noch unter bearbeiten</h1>
      </div>
      <div>
        <img src="cold_logo.jpg" alt="image" width="500rem" height="200rem">
      </div>
    </div> 
    <div>
      <button type="button" class="seeThrough"  id="open" >Mängel Eingeben</button>
    </div>
    <form class="form" id="form" onsubmit="saveAlert(event)">
      <div class="flexContainer">      
        <div>
            <div class="div4">
              <label>Kunde:</label>
              <input type="text" id="kunde" size="25" required >
                <label>Standort:</label>
                <input type="text" id="standort" size="25" required >
                  <label>Anlage:</label>
                  <input type="text" id="Anlage" size="25" required >
                  </div> 
                  <div class="div4">
                    <label>Mängel:</label>
                    <br>
                    <!-- <textarea class="inputBasicArea" name="maengel" id="maengel" cols="50" rows="8" required></textarea> -->
                    <input type="text" name="maengel1"  id="maengel1" size="45" value="" /><br>
                    <input type="text" name="maengel2"  id="maengel1" size="45" value="" /><br>
                    <input type="text" name="maengel3"  id="maengel1" size="45" value="" /><br>
                    <input type="text" name="maengel4"  id="maengel1" size="45" value="" /><br>
                    <input type="text" name="maengel5"  id="maengel1" size="45" value="" /><br>
                    <input type="text" name="maengel6"  id="maengel1" size="45" value="" /><br>
                    </div>
            
      </div>
      <div class="div4">
           <label class="addressBox">Datum:</label>
           <input type="date" id="date1" value="" required>
          </div>
          
        <div class="div4">
          <label>Techniker:</label>
          <input type="text" id="techniker" size="20" required >
          <button type="submit" class="seeThrough"  id="print" >Speichern</button>
          <button type="button" class="seeThrough"  id="close" >Schliessen</button>
          </div>
       
        </div>
      </div>
      </div>
      </form>
      <!-- Add a container to display the data -->
<div id="data-container">
  <h3>Stored Data</h3>
  <table id="data-table" border="1">
    <thead>
      <tr>
        <th>Kunde</th>
        <th>Standort</th>
        <th>Techniker</th>
        <th>Datum</th>
        <th>Mängel</th>
      </tr>
    </thead>
    <tbody>
      <!-- Data rows will be dynamically added here -->
    </tbody>
  </table>
</div>

    </body>
<script>
   const currentDate = new Date().toISOString().slice(0, 10);
   document.getElementById("date1").value = currentDate;
   const kundeValue_storage = localStorage.getItem("kunde");
  const standortValue_storage = localStorage.getItem("standort");
  const technikerValue_storage = localStorage.getItem("techniker");

  document.getElementById("kunde").value = kundeValue_storage;
  document.getElementById("standort").value = standortValue_storage;
  document.getElementById("techniker").value = technikerValue_storage;
  

   document.getElementById("open").addEventListener("click", function() {
    document.getElementById("form").style.display = "block";
    document.getElementById("open").style.display = "none";
  }); 
  document.getElementById("close").addEventListener("click", function() {
  document.getElementById("form").style.display = "none";
  document.getElementById("open").style.display = "block";
  }); 


  // Open (or create) the database
const request = indexedDB.open("Cold4YouDB", 1);


  request.onupgradeneeded = function(event) {
  const db = event.target.result; 
    // Create an object store for the form data
    const objectStore = db.createObjectStore("formData", { keyPath: "id", autoIncrement: true });
    console.log("object store created");

    // Define what data items the object store will contain
    objectStore.createIndex("kunde", "kunde", { unique: false});
    objectStore.createIndex("standort", "standort", { unique: false });
    objectStore.createIndex("techniker", "techniker", { unique: false });
    objectStore.createIndex("date1", "date1", { unique: false });
    objectStore.createIndex("maengel", "maengel", { unique: false });
  };

  request.onerror = (event) => {
  console.error("IndexedDB ERROR");
};



  // Function to save form data to IndexedDB
  function saveFormData() {
      const kundeValue = document.getElementById("kunde").value;
      const standortValue = document.getElementById("standort").value;
      const technikerValue = document.getElementById("techniker").value;
      const date1Value = document.getElementById("date1").value;
      const maengelValue = document.getElementsByName("maengel");

  localStorage.setItem("kunde", kundeValue);
  localStorage.setItem("standort", standortValue);
  localStorage.setItem("techniker", technikerValue);
  localStorage.setItem("date1", date1Value);

      const transaction = db.transaction(["formData"], "readwrite");
      const objectStore = transaction.objectStore("formData");

      const data = {
        kunde: kundeValue,
        standort: standortValue,
        techniker: technikerValue,
        date1: date1Value,
        maengel: maengelValue,
      };

      const request = objectStore.add(data);

      request.onsuccess = function() {
        console.log("Form data saved to IndexedDB");
      };
    };

function saveAlert(event){
   
  
      savePDF();
  console.log("save alert")
  document.getElementById("form").style.display = "none";
  document.getElementById("open").style.display = "block";
 

}



function savePDF() {
  var element = document.getElementById('el-to-print');
  html2pdf().set(opt).from(element).save(document.getElementById("title_change").innerHTML);
  console.log("save pdf");
  // document.getElementById("form").style.display = "none";
  // document.getElementById("open").style.display = "block";


}
var opt = {
  margin:       1.1,
  filename:     "Mängel_Liste",
  image:        { type: 'jpeg', quality: 1 },
  html2canvas:  { scale: 0.7, dpi: 600, },
  jsPDF:        { unit: 'in', format: 'a1', orientation: 'portrait' },
  
};
 // Call saveFormData function when form is submitted
 document.getElementById("form").onsubmit = function(event) {
      saveFormData();
      saveAlert();
    };

    // open db and get the data from the object store 
  request.onsuccess = (event) => {
  db = event.target.result;

 const transaction = db.transaction(["formData"], "readonly");
 const objectStore = transaction.objectStore("formData");
 const getAllRequest = objectStore.getAll();
 getAllRequest.onsuccess = function(event) {
    const data = event.target.result; // All data from the object store

//Display the data on the page
    const tableBody = document.getElementById("data-table").querySelector("tbody");
      tableBody.innerHTML = ""; // Clear existing rows

      data.forEach((item) => {
        const row = document.createElement("tr");

        // Add table cells for each field
        row.innerHTML = `
          <td>${item.kunde || ""}</td>
          <td>${item.standort || ""}</td>
          <td>${item.techniker || ""}</td>
          <td>${item.date1 || ""}</td>
          <td>${item.maengel || ""}</td>
        `

        tableBody.appendChild(row);
      });
    

    getAllRequest.onerror = function (event) {
      console.error("Error retrieving data:", event.target.errorCode);
    };
  

  request.onerror = function (event) {
    console.error("Error opening database:", event.target.errorCode);
  };
  };
   
 
};


 

  </script>
</html>

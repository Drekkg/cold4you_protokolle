<!DOCTYPE html>
<html>
  <head>
  <meta charset="UTF-8">
  <meta  name="viewport" content="width=device-width", initial-scale="1" >
  <title id="title_change"></title>
    <link rel="icon" type="image/x-icon" href="/favicon/favicon.png">
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js" integrity="sha512-YcsIPGdhPK4P/uRW6/sruonlYj+Q7UHWeKfTAkBW+g83NKM+jMJFJ4iAPfSnVp7BKD4dKMHmVSvICUbE/V1sSw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  </head>

  <body id="el-to-print">
    <div class="div1">
      <div>
        <h3>Cold4you Gewerbekälte GmbH</h3>
        <p style="font-size: large">Wiener Strasse 25, 2100 Korneuburg</p>
        <p style="font-size: large">Tel: 02262 / 235 25 </p>
        <p style="font-size: large">Email: office@cold4you.at </p>
        <p style="font-size: large">www.cold4you.at </p>
      </div>
      <div>
        <h1>Mängel Liste - Noch unter bearbeiten</h1>
      </div>
      <div>
        <a href="../index.html"><img src="cold_logo.jpg" alt="image" width="500rem" height="200rem"></a>
      </div>
    </div> 
    <div>
      <button type="button" class="seeThrough"  id="open" >Mängel Eingeben</button>
      <button type="button" class="pdf-speichern"  id="savePdf" >PDF Speichern</button>
      <input type="text" id="search" size="25" placeholder="Search" />
    </div>
    <form class="form" id="form">
      <div class="flexContainer">      
        <div>
            <div class="div4">
              <label>Kunde:</label>
              <input type="text" id="kunde" size="25" required />
                <label>Standort:</label>
                <input type="text" id="standort" size="25" required />
                  <label>Anlage:</label>
                  <input type="text" id="anlage" size="25" required />
                  </div> 
                  <div class="div4">
                    <label>Mängel:</label>
                    <br>
                    <input type="text" name="maengel1"  id="maengel1" size="65" value="" /><br>
                    <input type="text" name="maengel2"  id="maengel2" size="65" value="" /><br>
                    <input type="text" name="maengel3"  id="maengel3" size="65" value="" /><br>
                    <input type="text" name="maengel4"  id="maengel4" size="65" value="" /><br>
                    <input type="text" name="maengel5"  id="maengel5" size="65" value="" /><br>
                    <input type="text" name="maengel6"  id="maengel6" size="65" value="" /><br>
                    </div>
            
      </div>
      <div class="div4">
           <label class="addressBox">Datum:</label>
           <input type="date" id="dateCurrent" value="" required>
          </div>
          
        <div class="div4">
          <label>Techniker:</label>
          <input type="text" id="techniker" size="20" required >
          <button type="submit" class="seeThrough"  id="print" >Speichern</button>
          <button type="button" class="seeThrough"  id="close" >Schliessen</button>
          </div>
       
        </div>
      </div>
      </div>
      </form>
      <!-- Add a container to display the data -->
<div id="data-container">
  <h3>Stored Data</h3>
  <table id="data-table" class="table" border="1">
    <thead>
      <tr>
        <th>Kunde</th>
        <th>Standort</th>
        <th>Anlage</th>
        <th>Techniker</th>
        <th>Datum</th>
        <th colspan="6">Mängel</th>
      </tr>
    </thead>
    <tbody>
      <!-- Data rows will be dynamically added here -->
    </tbody>
  </table>
</div>

    </body>
    <script src="../indexDB-maengel.js"></script>
<script>
  //Initialise the date variable to hold the current date 
  // Get value from local storage to autofill important inputs of form

   const currentDate = new Date().toISOString().slice(0, 10);
   document.getElementById("dateCurrent").value = currentDate;

   const kundeValue_storage = localStorage.getItem("kunde");
   const standortValue_storage = localStorage.getItem("standort");
   const technikerValue_storage = localStorage.getItem("techniker");

  document.getElementById("kunde").value = kundeValue_storage;
  document.getElementById("standort").value = standortValue_storage;
  document.getElementById("techniker").value = technikerValue_storage;
  

    document.getElementById("open").addEventListener("click", function() {
    document.getElementById("form").style.display = "block";
    document.getElementById("open").style.display = "none";
    document.getElementById("savePdf").style.display = "none";
  }); 
  document.getElementById("close").addEventListener("click", function() {
  document.getElementById("form").style.display = "none";
  document.getElementById("open").style.display = "inline-block";
  document.getElementById("savePdf").style.display = "inline-block";

  }); 

document.getElementById("savePdf").addEventListener("click", function() {
   saveAlert();
  });

  function saveAlert() {
  if (confirm("PDF speichern?")){
      savePDF();
    }
  else{
    alert("PDF nicht gespeichert");
  }
};



function savePDF() {
  var element = document.getElementById('el-to-print');
  html2pdf().set(opt).from(element).save(document.getElementById("title_change").innerHTML);
  console.log("save pdf");
 

}
var opt = {
  margin:       1.1,
  filename:     "Mängel_Liste",
  image:        { type: 'jpeg', quality: 1 },
  html2canvas:  { scale: 0.7, dpi: 600, },
  jsPDF:        { unit: 'in', format: 'a1', orientation: 'portrait' },
  
};



// Prevent enter key from submitting form 
document.getElementById("form").addEventListener("keydown", function(event) {
  if(event.key === "Enter") {
    event.preventDefault();
  }
})

 // Call saveFormData function when form is submitted
 document.getElementById("form").onsubmit = function(event) {
      saveFormData();
      document.getElementById("form").style.display = "none";
      document.getElementById("open").style.display = "inline-block";
    };

    // open db and get the data from the object store 
  request.onsuccess = (event) => {
  db = event.target.result;

 const transaction = db.transaction(["formData"], "readonly");
 const objectStore = transaction.objectStore("formData");
 const getAllRequest = objectStore.getAll();
 getAllRequest.onsuccess = function (event) {
 const data = event.target.result; // All data from the object store

  // Display the data on the page
  const tableBody = document.getElementById("data-table").querySelector("tbody");
  tableBody.innerHTML = ""; // Clear existing rows

  // Function to render data into the table
  function renderTable(filteredData) {
    tableBody.innerHTML = ""; // Clear existing rows
    filteredData.forEach((item) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${item.kunde || ""}</td>
        <td>${item.standort || ""}</td>
        <td>${item.anlage || ""}</td>
        <td>${item.techniker || ""}</td>
        <td>${item.currentDate || ""}</td>
        <td>1: ${item.maengel1 || ""}</td>
        <td>2: ${item.maengel2 || ""}</td>
        <td>3: ${item.maengel3 || ""}</td>
        <td>4: ${item.maengel4 || ""}</td>
        <td>5: ${item.maengel5 || ""}</td>
        <td>6: ${item.maengel6 || ""}</td>
      `;
      tableBody.appendChild(row);
    });
  }

  // Initially render all data
  renderTable(data);

  // Initialize search bar and filter the displayed data
  document.getElementById("search").addEventListener("input", () => {
    const key = document.getElementById("search").value.toLowerCase();

    // Filter the data based on the search key
    const filteredData = data.filter((item) => {
      return (
        (item.kunde && item.kunde.toLowerCase().includes(key)) ||
        (item.standort && item.standort.toLowerCase().includes(key)) ||
        (item.anlage && item.anlage.toLowerCase().includes(key)) ||
        (item.techniker && item.techniker.toLowerCase().includes(key)) ||
        (item.currentDate && item.currentDate.toLowerCase().includes(key)) ||
        (item.maengel1 && item.maengel1.toLowerCase().includes(key)) ||
        (item.maengel2 && item.maengel2.toLowerCase().includes(key)) ||
        (item.maengel3 && item.maengel3.toLowerCase().includes(key)) ||
        (item.maengel4 && item.maengel4.toLowerCase().includes(key)) ||
        (item.maengel5 && item.maengel5.toLowerCase().includes(key)) ||
        (item.maengel6 && item.maengel6.toLowerCase().includes(key)) 
      );
    });

    // Render the filtered data
    renderTable(filteredData);
  });
};

};
  </script>
</html>
